<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos Bio-Fix - Mobile</title>
  <style>
    :root{
      --bg-white:#ffffff;
      --bg-gray:#e6e6e6;
      --bf-blue:#1168a7;
      --text:#222;

      --sys-monopieza:#00bcd4;
      --sys-hi:#d4101b;
      --sys-he:#429d56;
      --sys-conomorse:#926db2;
      --sys-basal:#666666;
      --sys-compresivo:#d10084;
      --sys-multiunit:#fab211;
      --sys-digitales:#4f039b;
      --sys-analogicos:#333333;

      --safe-margin:14px;
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    html,body{height:100%;margin:0;background:var(--bg-white);color:var(--text)}
    .app{max-width:420px;margin:0 auto;border-left:1px solid #ddd;border-right:1px solid #ddd;min-height:100vh;background:linear-gradient(180deg, #fff 0%, #fbfbfb 100%);}
    header{background:var(--bf-blue);color:#fff;padding:18px var(--safe-margin);display:flex;gap:12px;align-items:center}
    header img{width:44px;height:44px;border-radius:8px;object-fit:cover}
    header h1{font-size:18px;margin:0}
    .container{padding:16px}
    .card{background:var(--bg-white);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(17,104,167,0.06)}
    .big-btn{display:block;width:100%;padding:14px;border-radius:10px;border:0;font-weight:600;font-size:16px}
    .btn-primary{background:var(--bf-blue);color:#fff}
    .btn-outline{background:transparent;border:1px solid #ddd;color:var(--text);padding:8px;border-radius:8px}
    .row{display:flex;gap:8px}
    .col{flex:1}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text], input[type=number], select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
    .hidden{display:none}
    .spaced{margin-top:12px}
    .small{font-size:13px;color:#666}
    .system-list{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .system-item{padding:10px;border-radius:10px;text-align:center;font-weight:600;color:#fff;cursor:pointer}
    .list-group{display:flex;flex-direction:column;gap:8px}
    .product-row{display:flex;gap:8px;align-items:center}
    .product-row input{width:72px}
    .product-title{font-weight:600}
    .summary-list{display:flex;flex-direction:column;gap:10px}
    .summary-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #eee}
    .small-muted{font-size:12px;color:#777}
    footer{padding:12px;background:linear-gradient(180deg, transparent, #fff);position:sticky;bottom:0}
    .vendor{display:flex;gap:10px;align-items:center}
    .vendor img{width:48px;height:48px;border-radius:8px;object-fit:cover}
    .pill{padding:6px 10px;border-radius:999px;font-weight:700}
    .controls{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' fill='%231168a7' rx='16'/%3E%3Ctext x='50%' y='54%' font-size='36' text-anchor='middle' fill='%23fff' font-family='Arial' dy='.36em'%3EBF%3C/text%3E%3C/svg%3E" alt="Bio-Fix">
      <div>
        <h1>Pedidos Bio-Fix</h1>
        <div class="small">Pedidos r√°pidos ¬∑ m√≥vil</div>
      </div>
    </header>

    <div class="container">
      <section id="inicio" class="card">
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">
          <div style="flex:1">
            <div class="small-muted">Contacto de ventas</div>
            <div style="font-weight:700">Depto Ventas ¬∑ +54 9 11 6433-6112</div>
          </div>
          <div style="width:60px;text-align:right">
            <img src="https://via.placeholder.com/60x60.png?text=V" alt="vendedor" style="width:54px;height:54px;border-radius:8px;object-fit:cover">
          </div>
        </div>

        <button class="big-btn btn-primary" id="btnNuevo">Nuevo cliente</button>
        <button class="big-btn btn-outline spaced" id="btnFrecuente">Cliente frecuente</button>
      </section>

      <section id="formNuevo" class="card hidden">
        <div class="small-muted">Completa tus datos</div>
        <div class="spaced">
          <label>Nombre y apellido</label>
          <input type="text" id="inpNombre" placeholder="Ej: Juan P√©rez">
        </div>
        <div class="row spaced">
          <div class="col">
            <label>DNI</label>
            <input type="text" id="inpDni" placeholder="Sin puntos">
          </div>
          <div class="col">
            <label>CUIT</label>
            <input type="text" id="inpCuit" placeholder="XX-XXXXXXXX-X">
          </div>
        </div>
        <div class="row spaced">
          <div class="col">
            <label>Provincia</label>
            <select id="inpProvincia">
              <option value="">Seleccion√° provincia</option>
              <option>Buenos Aires</option>
              <option>Ciudad Aut√≥noma de Buenos Aires</option>
              <option>Catamarca</option>
              <option>Chaco</option>
              <option>Chubut</option>
              <option>C√≥rdoba</option>
              <option>Corrientes</option>
              <option>Entre R√≠os</option>
              <option>Formosa</option>
              <option>Jujuy</option>
              <option>La Pampa</option>
              <option>La Rioja</option>
              <option>Mendoza</option>
              <option>Misiones</option>
              <option>Neuqu√©n</option>
              <option>R√≠o Negro</option>
              <option>Salta</option>
              <option>San Juan</option>
              <option>San Luis</option>
              <option>Santa Cruz</option>
              <option>Santa Fe</option>
              <option>Santiago del Estero</option>
              <option>Tierra del Fuego</option>
              <option>Tucum√°n</option>
            </select>
          </div>
          <div class="col">
            <label>MP (matr√≠cula profesional)</label>
            <input type="text" id="inpMP" placeholder="Opcional">
          </div>
        </div>
        <div class="spaced">
          <label>Localidad</label>
          <input type="text" id="inpLocalidad" placeholder="Ej: Rosario">
        </div>

        <div class="spaced" style="display:flex;gap:8px">
          <button class="big-btn btn-outline" id="btnVolverInicio">‚¨ÖÔ∏è Volver</button>
          <button class="big-btn btn-primary" id="btnContinuar">‚û°Ô∏è Continuar</button>
        </div>
      </section>

      <section id="categorias" class="card hidden">
        <div class="small-muted">Agregar al pedido</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px">
          <button class="big-btn" id="catImplantes" style="background:var(--bg-gray);">Implantes</button>
          <button class="big-btn" id="catAnalogicos" style="background:var(--sys-analogicos);color:#fff">Componentes Anal√≥gicos</button>
          <button class="big-btn" id="catDigitales" style="background:var(--sys-digitales);color:#fff">Componentes Digitales</button>
          <button class="big-btn" id="catHerramental" style="background:var(--sys-herramental);color:#fff">Herramental</button>
        </div>

        <div class="spaced controls">
          <button class="big-btn btn-outline" id="btnVerResumen">üîç Ver resumen</button>
          <button class="big-btn btn-primary" id="btnFinalizar">‚úÖ Finalizar pedido</button>
        </div>
      </section>

      <!-- IMPLANTES -->
      <section id="implantes" class="card hidden">
        <div class="small-muted">Seleccion√° sistema</div>
        <div class="system-list spaced">
          <div class="system-item" data-sys="Monopieza" style="background:var(--sys-monopieza)">Monopieza</div>
          <div class="system-item" data-sys="Basal" style="background:var(--sys-basal)">Basal</div>
          <div class="system-item" data-sys="Compresivo Multiunit" style="background:var(--sys-compresivo)">Compresivo</div>
          <div class="system-item" data-sys="Hex√°gono Interno" style="background:var(--sys-hi)">Hex√°gono Int.</div>
          <div class="system-item" data-sys="Hex√°gono Externo" style="background:var(--sys-he)">Hex√°gono Ext.</div>
          <div class="system-item" data-sys="Cono Morse" style="background:var(--sys-conomorse)">Cono Morse</div>
        </div>
        <div class="spaced" style="display:flex;gap:8px">
          <button class="big-btn btn-outline" id="implantesAtras">‚¨ÖÔ∏è Atr√°s</button>
          <button class="big-btn btn-primary" id="implantesGuardar">üíæ Guardar</button>
        </div>

        <div id="implanteMedidas" class="spaced list-group"></div>
      </section>

      <!-- COMPONENTES -->
      <section id="componentes" class="card hidden">
        <div class="small-muted" id="compTitle">Componentes</div>
        <div class="system-list spaced" id="compSystems"></div>

        <div class="spaced" style="display:flex;gap:8px">
          <button class="big-btn btn-outline" id="compAtras">‚¨ÖÔ∏è Atr√°s</button>
          <button class="big-btn btn-primary" id="compGuardar">üíæ Guardar</button>
        </div>

        <div id="compItems" class="spaced list-group"></div>
      </section>

      <section id="resumen" class="card hidden">
        <div class="small-muted">Resumen del pedido</div>
        <div class="summary-list spaced" id="resumenList"></div>
        <div class="spaced" style="display:flex;gap:8px">
          <button class="big-btn btn-outline" id="resumenAtras">‚¨ÖÔ∏è Volver</button>
          <button class="big-btn btn-primary" id="resumenFinalizar">‚úÖ Enviar por WhatsApp</button>
        </div>
      </section>

      <section id="finalizar" class="card hidden">
        <div class="small-muted">Eleg√≠ a qui√©n enviar</div>
        <div class="vendor spaced" style="align-items:flex-start">
          <img src="https://via.placeholder.com/80x80.png?text=V" alt="vendedor">
          <div>
            <div style="font-weight:800">Depto Ventas</div>
            <div class="small-muted">+54 9 11 6433-6112</div>
          </div>
        </div>
        <div class="spaced" style="display:flex;gap:8px">
          <button class="big-btn btn-outline" id="finalAtras">‚¨ÖÔ∏è Atr√°s</button>
          <button class="big-btn btn-primary" id="sendWpp">Abrir WhatsApp</button>
        </div>
      </section>

    </div>

    <footer>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small-muted">Items en carrito</div>
          <div id="cartCount" style="font-weight:800">0</div>
        </div>
        <div>
          <button class="big-btn btn-primary" id="irResumen">Ver resumen</button>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const PHONE = '5491164336112';

    // --- cat√°logo (ya basado en lo que enviaste) ---
    const products = {
      "Implantes": {
        "Hex√°gono Interno": [
          "√ò3.0 x 6.5 mm","√ò3.0 x 8 mm","√ò3.0 x 10 mm","√ò3.0 x 11.5 mm","√ò3.0 x 13 mm","√ò3.0 x 16 mm",
          "√ò3.75 x 6.5 mm","√ò3.75 x 8 mm","√ò3.75 x 10 mm","√ò3.75 x 11.5 mm","√ò3.75 x 13 mm","√ò3.75 x 16 mm",
          "√ò4.2 x 6.5 mm","√ò4.2 x 8 mm","√ò4.2 x 10 mm","√ò4.2 x 11.5 mm","√ò4.2 x 13 mm","√ò4.2 x 16 mm",
          "√ò5.0 x 6.5 mm","√ò5.0 x 8 mm","√ò5.0 x 10 mm","√ò5.0 x 11.5 mm","√ò5.0 x 13 mm","√ò5.0 x 16 mm"
        ],
        "Hex√°gono Externo": {
          "√ò3.30 (Plataforma √ò3.4)": ["8.5 mm","10 mm","11.5 mm","13 mm","15 mm"],
          "√ò3.75 (Plataforma √ò4.1)": ["8.5 mm","10 mm","11.5 mm","13 mm","15 mm"],
          "√ò4.0 (Plataforma √ò4.1)": ["6 mm","8.5 mm","10 mm","11.5 mm","13 mm","15 mm"],
          "√ò5.0 (Plataforma √ò5.0)": ["8.5 mm","10 mm","11.5 mm","13 mm","15 mm"]
        },
        "Cono Morse": [
          "√ò3.30 x 8 mm","√ò3.30 x 10 mm","√ò3.0 x 11.5 mm","√ò3.30 x 13 mm","√ò3.30 x 16 mm",
          "√ò3.75 x 8 mm","√ò3.75 x 10 mm","√ò3.75 x 11.5 mm","√ò3.75 x 13 mm","√ò3.75 x 16 mm",
          "√ò4.2 x 8 mm","√ò4.2 x 10 mm","√ò4.2 x 11.5 mm","√ò4.2 x 13 mm","√ò4.2 x 16 mm",
          "√ò5.0 x 8 mm","√ò5.0 x 10 mm","√ò5.0 x 11.5 mm","√ò5.0 x 13 mm","√ò5.0 x 16 mm"
        ],
        "Monopieza": [ /* ... */ ],
        "Monopieza Basal": {
          "Pulido": [
            "√ò3.5 x 10 mm","√ò3.5 x 12 mm","√ò3.5 x 15 mm","√ò3.5 x 18 mm","√ò3.5 x 21 mm","√ò3.5 x 23 mm","√ò3.5 x 24 mm","√ò3.5 x 26 mm","√ò3.5 x 28 mm"
          ],
          "Tratamiento superficial": [
            "√ò3.5 x 10 mm","√ò3.5 x 12 mm","√ò3.5 x 15 mm","√ò3.5 x 18 mm"
          ]
        },
        "Compresivo Multiunit": [
          "√ò3.0 x 6 mm","√ò3.0 x 8 mm","√ò3.0 x 10 mm","√ò3.0 x 11.5 mm"
        ]
      },
      "Componentes Anal√≥gicos": {
        "Hex√°gono Interno": {
          "Ucla Calcinable": {"Rotacional":["Plat √ò3.4","Plat √ò4.1","Plat √ò5.0"], "Anti-Rotacional":["Plat √ò3.4","Plat √ò4.1","Plat √ò5.0"]},
          "An√°logo de Titanio": [],
          "BallAttach y Cazoleta": ["H1","H2","H3","H4"],
          "Tapa de cicatrizaci√≥n": ["H1","H2","H3","H4"],
          "Transfer cubeta": ["Abierta","Cerrada"],
          "Pilar recto c/tornillo": ["H1","H2","H3","H4"],
          "Minipilar Angulado H.I + Llave transportadora + tornillo": ["1.5 mm","2.5 mm","3.5 mm"],
          "Pilar angulado c/tornillo": ["15¬∞","25¬∞"]
        },
        "Hex√°gono Externo": {
          "Ucla Calcinable": {
            "Rotacional": {"Plat √ò3.4":["H1","H2","H3","H4"], "Plat √ò4.1":["H1","H2","H3","H4"], "Plat √ò5.0":["H1","H2","H3","H4"]},
            "Anti-Rotacional": {"Plat √ò3.4":["H1","H2","H3","H4"], "Plat √ò4.1":["H1","H2","H3","H4"], "Plat √ò5.0":["H1","H2","H3","H4"]}
          },
          "Tapa de cicatrizaci√≥n": {"Plat √ò3.4":["H1","H2","H3"], "Plat √ò4.1":["H1","H2","H3"], "Plat √ò5.0":["H1","H2","H3"]},
          "Transfer cubeta": {"Plat √ò3.4":["Abierta","Cerrada"], "Plat √ò4.1":["Abierta","Cerrada"], "Plat √ò5.0":["Abierta","Cerrada"]},
          "Ball Attach": {"Plat √ò3.4":["H1","H2","H3","H4"], "Plat √ò4.1":["H1","H2","H3","H4"], "Plat √ò5.0":["H1","H2","H3","H4"]},
          "Pilar recto c/tornillo": {"Plat √ò3.4":{"H1-H3":["Hexagonal","Cuadrado"]}, "Plat √ò4.1":{"H1-H3":["Hexagonal","Cuadrado"]}, "Plat √ò5.0":{"H1-H3":["Hexagonal","Cuadrado"]}},
          "Tornillo prot√©sico": ["Cuadrado","Hexagonal"],
          "Pilar angulado c/tornillo": {"Plat √ò4.1":["15¬∞","25¬∞"]}
        },
        "Cono Morse": {
          "Pilares est√°ndar": {"√ò3.3":["√ò3.3x0.8x4","√ò3.3x1.5x4","√ò3.3x2.5x4","√ò3.3x3.5x4"], "√ò4.5":["√ò4.5x0.8x4","√ò4.5x1.5x4"]},
          "Pilares c/tornillo pasante": {"√ò3.3":["..."], "√ò4.5":["..."]},
          "Pilares de cicatrizaci√≥n": {"√ò3.3":["H1.5","H2.5","H3.5"], "√ò4.5":["H1.5","H2.5","H3.5"]},
          "An√°logo Universal": [],
          "BallAttach y Cazoleta": ["H1.5","H2.5","H3.5","H4.5","H5.5"]
        },
        "Monopieza": {
          "An√°logo": [],
          "Ucla Calcinable": ["√ò3.0","√ò3.5","√ò4.0","√ò4.5","√ò5.0"],
          "Transfer Rotacional": []
        },
        "Compresivo Multiunit": {
          "Transfer Cubeta Abierta": [],
          "Cicatrizal c/tornillo": ["H2","H3","H4"],
          "BallAttach y cazoleta": ["H2","H3","H4"],
          "Pilar Recto c/tornillo": []
        }
      },
      "Componentes Digitales": {
        "Hex√°gono Interno": {
          "Analogo Digital": ["√önico"],
          "T-Base": ["Rotacional √ò4.3","No Rotacional √ò4.3"]
        }
      },
      "Herramental": {
        "Fresa Lanza": ["Corta","Larga"],
        "Fresa Helicoidal": ["√ò2.0","√ò2.5","√ò2.8","√ò3.2","√ò3.6","√ò4.0","√ò4.3","√ò4.6","√ò5.0","√ò5.3"],
        "Punta Driver para Monopieza": ["Larga","Corta"],
        "Prolongador 4x4": ["Corto","Largo"],
        "Punch": ["3.4 mm","4.1 mm","5.0 mm"]
      }
    };

    // estado
    let cliente = null;
    let cart = [];

    // util
    const $ = id => document.getElementById(id);
    const show = id => { document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); $(id).classList.remove('hidden'); window.scrollTo(0,0) }
    const updateCartCount = ()=>{ $('cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0) }

    // mapping para que el bot√≥n "Basal" busque "Monopieza Basal"
    function getImplantKey(sys){
      if(sys === 'Basal') return 'Monopieza Basal';
      return sys;
    }

    // inicio botones
    $('btnNuevo').addEventListener('click',()=>show('formNuevo'));
    $('btnFrecuente').addEventListener('click',()=>{cliente = {name:'Cliente frecuente'}; show('categorias')});
    $('btnVolverInicio').addEventListener('click',()=>show('inicio'));
    $('btnContinuar').addEventListener('click',()=>{
      const nombre = $('inpNombre').value.trim();
      if(!nombre){alert('Ingres√° nombre y apellido');return}
      cliente = {
        name:nombre,
        dni:$('inpDni').value.trim(),
        cuit:$('inpCuit').value.trim(),
        provincia:$('inpProvincia').value,
        mp:$('inpMP').value.trim(),
        localidad:$('inpLocalidad').value.trim()
      };
      show('categorias');
    });

    $('catImplantes').addEventListener('click',()=>{prepareImplantes(); show('implantes')});
    $('catAnalogicos').addEventListener('click',()=>{prepareComponentes('Componentes Anal√≥gicos'); show('componentes')});
    $('catDigitales').addEventListener('click',()=>{prepareComponentes('Componentes Digitales'); show('componentes')});
    $('catHerramental').addEventListener('click',()=>{prepareComponentes('Herramental'); show('componentes')});

    $('btnVerResumen').addEventListener('click',()=>{renderResumen(); show('resumen')});
    $('btnFinalizar').addEventListener('click',()=>{renderResumen(); show('finalizar')});
    $('irResumen').addEventListener('click',()=>{renderResumen(); show('resumen')});

    // ---------- IMPLANTES (mantener lista de medidas) ----------
    function prepareImplantes(){
      const cont = $('implanteMedidas'); cont.innerHTML='';
      document.querySelectorAll('#implantes .system-item').forEach(el=>{
        el.onclick = ()=>{
          const sys = getImplantKey(el.dataset.sys);
          renderImplanteMedidas(sys);
        }
      });
    }

    function renderImplanteMedidas(sys){
      const raw = products.Implantes && products.Implantes[sys];
      const cont = $('implanteMedidas'); cont.innerHTML='';
      if(!raw){ cont.innerHTML = '<div class="small-muted">No hay productos para este sistema.</div>'; return }
      // si raw es array => medidas separadas
      if(Array.isArray(raw)){
        raw.forEach(m=>{
          const row = document.createElement('div'); row.className='product-row';
          row.innerHTML = `<div style="flex:1"><div class='product-title'>${escapeHtml(m)}</div><div class='small-muted'>Sistema: ${escapeHtml(sys)}</div></div>
            <div style='width:140px;display:flex;gap:6px;align-items:center'>
              <input type='number' min='0' value='0' class='qty' />
              <button class='btn-outline'>Agregar</button>
            </div>`;
          const btn = row.querySelector('button');
          btn.addEventListener('click',()=>{
            const qty = parseInt(row.querySelector('.qty').value)||0;
            if(qty<=0){ alert('Ingres√° cantidad mayor a 0'); return }
            cart.push({cat:'Implantes', system:sys, name:m, qty});
            updateCartCount();
            row.querySelector('.qty').value = 0;
            alert('Producto agregado');
          });
          cont.appendChild(row);
        });
        return;
      }
      // si raw es objeto (ej: Monopieza Basal) => aplanar por claves (Pulido / Tratamiento)
      if(typeof raw === 'object'){
        // cada clave puede ser array u objeto anidado
        Object.keys(raw).forEach(k=>{
          const val = raw[k];
          if(Array.isArray(val)){
            val.forEach(m=>{
              const row = document.createElement('div'); row.className='product-row';
              row.innerHTML = `<div style="flex:1"><div class='product-title'>${escapeHtml(m)}</div><div class='small-muted'>${escapeHtml(sys)} ¬∑ ${escapeHtml(k)}</div></div>
                <div style='width:140px;display:flex;gap:6px;align-items:center'>
                  <input type='number' min='0' value='0' class='qty' />
                  <button class='btn-outline'>Agregar</button>
                </div>`;
              const btn = row.querySelector('button');
              btn.addEventListener('click',()=>{
                const qty = parseInt(row.querySelector('.qty').value)||0;
                if(qty<=0){ alert('Ingres√° cantidad mayor a 0'); return }
                cart.push({cat:'Implantes', system:sys, name:`${k} ¬∑ ${m}`, qty});
                updateCartCount();
                row.querySelector('.qty').value = 0;
                alert('Producto agregado');
              });
              cont.appendChild(row);
            });
          } else {
            // objeto m√°s profundo: lo convertimos en label compuesto
            // ejemplo: Monopieza Basal -> Pulido -> ...
            const deep = flattenObjectToEntries(val, [k]);
            deep.forEach(e=>{
              const row = document.createElement('div'); row.className='product-row';
              row.innerHTML = `<div style="flex:1"><div class='product-title'>${escapeHtml(e.name)}</div><div class='small-muted'>${escapeHtml(sys)} ¬∑ ${escapeHtml(e.path.join(' ¬∑ '))}</div></div>
                <div style='width:140px;display:flex;gap:6px;align-items:center'>
                  <input type='number' min='0' value='0' class='qty' />
                  <button class='btn-outline'>Agregar</button>
                </div>`;
              const btn = row.querySelector('button');
              btn.addEventListener('click',()=>{
                const qty = parseInt(row.querySelector('.qty').value)||0;
                if(qty<=0){ alert('Ingres√° cantidad mayor a 0'); return }
                cart.push({cat:'Implantes', system:sys, name:`${e.path.join(' ¬∑ ')} ¬∑ ${e.name}`, qty});
                updateCartCount();
                row.querySelector('.qty').value = 0;
                alert('Producto agregado');
              });
              cont.appendChild(row);
            });
          }
        });
      }
    }

    function flattenObjectToEntries(node, breadcrumbs = []){
      const out = [];
      if(Array.isArray(node)){
        node.forEach(item=>{
          out.push({name:String(item), path:breadcrumbs.slice()});
        });
      } else if(node && typeof node === 'object'){
        Object.keys(node).forEach(k=>{
          const v = node[k];
          if(Array.isArray(v)){
            v.forEach(item=> out.push({name:String(item), path:breadcrumbs.concat([k])}));
          } else {
            out.push(...flattenObjectToEntries(v, breadcrumbs.concat([k])));
          }
        });
      }
      return out;
    }

    // ---------- COMPONENTES (nuevo comportamiento: variantes con select) ----------
    let currentCompCategory = null;
    function prepareComponentes(cat){
      currentCompCategory = cat;
      $('compTitle').innerText = cat;
      const systems = Object.keys(products[cat] || {});
      const sysCont = $('compSystems'); sysCont.innerHTML='';
      systems.forEach(s=>{
        const div = document.createElement('div'); div.className='system-item'; div.dataset.sys=s; div.innerText=s;
        div.style.background = mapSysColor(s);
        sysCont.appendChild(div);
        div.onclick = ()=> renderCompItems(cat,s);
      });
      $('compItems').innerHTML='';
    }

    // construye entradas para render: si hay variantes -> {display, variants: [...]} ; si no -> {display}
    function buildComponentEntries(node, breadcrumbs = []){
      const entries = [];
      if(Array.isArray(node)){
        // Si estamos en un array directamente (ej: list of sizes), devolver cada uno como producto final sin variantes
        node.forEach(item => entries.push({ display: [...breadcrumbs].join(' ¬∑ ')+ (breadcrumbs.length? ' ¬∑ ':'') + String(item), variants: null }));
        return entries;
      }
      if(node && typeof node === 'object'){
        Object.keys(node).forEach(key=>{
          const val = node[key];
          // caso: val es array de strings -> -> el producto es `key` y las variantes son val
          if(Array.isArray(val)){
            entries.push({ display: [...breadcrumbs, key].join(' ¬∑ '), variants: val.slice() });
          } else if (val && typeof val === 'object'){
            // val es objeto: puede tener capas (ej: Ucla Calcinable -> Rotacional -> Plat √ò3.4 -> [H1...])
            // recorrer en profundidad: cada vez que lleguemos a un array construir display concatenado
            Object.keys(val).forEach(k2=>{
              const v2 = val[k2];
              if(Array.isArray(v2)){
                entries.push({ display: [...breadcrumbs, key, k2].join(' ¬∑ '), variants: v2.slice() });
              } else if (v2 && typeof v2 === 'object'){
                // un nivel m√°s (ej: Rotacional -> Plat √ò3.4 -> [H1...])
                Object.keys(v2).forEach(k3=>{
                  const v3 = v2[k3];
                  if(Array.isArray(v3)){
                    entries.push({ display: [...breadcrumbs, key, k2, k3].join(' ¬∑ '), variants: v3.slice() });
                  } else {
                    // si llega m√°s profundo, aplanar recursivamente
                    entries.push(...buildComponentEntries(v2[k3], [...breadcrumbs, key, k2, k3]));
                  }
                });
              }
            });
          } else {
            // val vac√≠o o no definido => producto sin variantes (se muestra como key)
            entries.push({ display: [...breadcrumbs, key].join(' ¬∑ '), variants: null });
          }
        });
      }
      return entries;
    }

    function renderCompItems(cat, sys){
      const raw = products[cat] && products[cat][sys];
      const cont = $('compItems'); cont.innerHTML='';
      if(!raw){ cont.innerHTML = '<div class="small-muted">No hay productos para este sistema.</div>'; return }
      const entries = buildComponentEntries(raw, []);
      if(entries.length===0){ cont.innerHTML = '<div class="small-muted">No hay items.</div>'; return }
      entries.forEach(e=>{
        const row = document.createElement('div'); row.className='product-row';
        if(e.variants && e.variants.length>0){
          // producto con variantes -> mostrar select + qty + agregar
          const optionsHtml = e.variants.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
          row.innerHTML = `<div style="flex:1">
              <div class='product-title'>${escapeHtml(e.display)}</div>
              <div class='small-muted'>${escapeHtml(cat)} ¬∑ ${escapeHtml(sys)}</div>
            </div>
            <div style='width:220px;display:flex;flex-direction:column;gap:6px'>
              <select class="variant-select">${optionsHtml}</select>
              <div style="display:flex;gap:6px">
                <input type='number' min='0' value='0' class='qty' />
                <button class='btn-outline btn-add'>Agregar</button>
              </div>
            </div>`;
          cont.appendChild(row);
          const btn = row.querySelector('.btn-add');
          btn.addEventListener('click',()=>{
            const sel = row.querySelector('.variant-select').value;
            const qty = parseInt(row.querySelector('.qty').value)||0;
            if(qty<=0){ alert('Ingres√° cantidad mayor a 0'); return }
            cart.push({cat, system:sys, name:`${e.display} ¬∑ ${sel}`, qty});
            updateCartCount();
            row.querySelector('.qty').value = 0;
            alert('Producto agregado');
          });
        } else {
          // producto sin variantes -> input qty + agregar
          row.innerHTML = `<div style="flex:1">
              <div class='product-title'>${escapeHtml(e.display)}</div>
              <div class='small-muted'>${escapeHtml(cat)} ¬∑ ${escapeHtml(sys)}</div>
            </div>
            <div style='width:140px;display:flex;gap:6px;align-items:center'>
              <input type='number' min='0' value='0' class='qty' />
              <button class='btn-outline btn-add'>Agregar</button>
            </div>`;
          cont.appendChild(row);
          const btn = row.querySelector('.btn-add');
          btn.addEventListener('click',()=>{
            const qty = parseInt(row.querySelector('.qty').value)||0;
            if(qty<=0){ alert('Ingres√° cantidad mayor a 0'); return }
            cart.push({cat, system:sys, name:e.display, qty});
            updateCartCount();
            row.querySelector('.qty').value = 0;
            alert('Producto agregado');
          });
        }
      });
    }

    $('compAtras').addEventListener('click',()=>show('categorias'));
    $('compGuardar').addEventListener('click',()=>{renderResumen(); show('categorias')});

    // ---------- RESUMEN ----------
    function renderResumen(){
      const list = $('resumenList'); list.innerHTML='';
      if(cart.length===0){ list.innerHTML = '<div class="small-muted">No hay productos en el pedido.</div>'; return }
      cart.forEach((it,idx)=>{
        const div = document.createElement('div'); div.className='summary-item';
        div.innerHTML = `<div><div style='font-weight:800'>${escapeHtml(it.name)}</div><div class='small-muted'>${escapeHtml(it.cat)} ¬∑ ${escapeHtml(it.system || '')}</div></div>
          <div style='display:flex;flex-direction:column;gap:6px;align-items:flex-end'>
            <div style='font-weight:800'>x ${it.qty}</div>
            <div style='display:flex;gap:6px'>
              <button data-del='${idx}' class='btn-outline'>Eliminar</button>
              <button data-edit='${idx}' class='btn-outline'>Editar</button>
            </div>
          </div>`;
        list.appendChild(div);
      });
      list.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
        const i = parseInt(b.getAttribute('data-del'));
        if(isNaN(i)) return;
        cart.splice(i,1); renderResumen(); updateCartCount();
      }));
      list.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{
        const i = parseInt(b.getAttribute('data-edit'));
        if(isNaN(i)) return;
        const newQty = prompt('Modificar cantidad', cart[i].qty);
        if(newQty !== null){
          const n = parseInt(newQty)||0;
          if(n<=0){ alert('Cantidad inv√°lida'); return }
          cart[i].qty = n; renderResumen(); updateCartCount();
        }
      }));
    }

    $('resumenAtras').addEventListener('click',()=>show('categorias'));
    $('resumenFinalizar').addEventListener('click',()=>show('finalizar'));

    // ---------- FINALIZAR ----------
    $('finalAtras').addEventListener('click',()=>show('resumen'));
    $('sendWpp').addEventListener('click', sendWhatsApp);

    function sendWhatsApp(){
      if(cart.length===0){ alert('El pedido est√° vac√≠o'); return }
      const lines = [];
      lines.push('üßæ *Nuevo Pedido - Bio-Fix*');
      if(cliente) lines.push(`üë§ Cliente: ${cliente.name || ''}`);
      if(cliente && cliente.localidad) lines.push(`üìç Localidad: ${cliente.localidad}${cliente.provincia?(', '+cliente.provincia):''}`);
      if(cliente && cliente.dni) lines.push(`üÜî DNI: ${cliente.dni}`);
      lines.push('');
      lines.push('*Detalles del pedido:*');
      cart.forEach(it => lines.push(`- ${it.name} (${it.system||it.cat}) x ${it.qty}`));
      lines.push('');
      lines.push(`üì¶ Total de √≠tems: ${cart.reduce((s,i)=>s+i.qty,0)}`);
      const text = encodeURIComponent(lines.join('\n'));
      const url = `https://wa.me/${PHONE}?text=${text}`;
      window.open(url,'_blank');
    }

    // ---------- helpers ----------
    function mapSysColor(sys){
      const map = {
        'Monopieza':'var(--sys-monopieza)','Basal':'var(--sys-basal)','Compresivo Multiunit':'var(--sys-compresivo)',
        'Hex√°gono Interno':'var(--sys-hi)','Hex√°gono Externo':'var(--sys-he)','Cono Morse':'var(--sys-conomorse)',
        'Componentes Anal√≥gicos':'var(--sys-analogicos)','Componentes Digitales':'var(--sys-digitales)','Herramental':'var(--sys-herramental)'
      };
      if(map[sys]) return map[sys];
      if(sys.toLowerCase().includes('hex√°gono interno')) return 'var(--sys-hi)';
      if(sys.toLowerCase().includes('hex√°gono externo')) return 'var(--sys-he)';
      return 'var(--bg-gray)';
    }

    function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // init
    show('inicio');
  </script>
</body>
</html>
